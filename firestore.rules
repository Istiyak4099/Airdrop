rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * CORE PHILOSOPHY
     * This ruleset enforces a strict user-ownership model centered around a private root document for each user.
     * It has been updated to support "anonymous-user" as a valid fallback for prototyping.
     */

    // --- HELPER FUNCTIONS ---

    /** Checks if the request is from an authenticated user. */
    function isSignedIn() {
      return request.auth != null;
    }

    /** Checks if the authenticated user's UID matches the provided userId or is the anonymous fallback. */
    function isOwner(userId) {
      return (isSignedIn() && request.auth.uid == userId) || userId == "anonymous-user";
    }

    /** Checks if the user is the owner and the document currently exists. */
    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }

    /** Ensures that a specific field is not modified during an update. */
    function isUnchanged(field) {
      return !(field in request.resource.data) || request.resource.data[field] == resource.data[field];
    }

    // --- COLLECTION RULES ---

    /**
     * @description Facebook Page credentials for automated replies.
     * Webhook needs public 'get' to fetch tokens by pageId since API routes act as unauthenticated.
     */
    match /facebook_pages/{pageId} {
      allow get: if true; 
      allow list: if true; // Permissive for prototyping
      allow create, update, delete: if true; // Permissive for prototyping
    }

    /**
     * @description Rules for the primary user account document.
     * @path /userAccounts/{userAccountId}
     */
    match /userAccounts/{userAccountId} {
      allow get: if isOwner(userAccountId);
      allow list: if false;
      allow create: if isOwner(userAccountId);
      allow update: if isExistingOwner(userAccountId) && isUnchanged('id');
      allow delete: if isExistingOwner(userAccountId);

      /**
       * @description Conversation threads for a specific user.
       */
      match /conversations/{conversationId} {
        allow get, list: if isOwner(userAccountId);
        allow create: if isOwner(userAccountId) && request.resource.data.userAccountId == userAccountId;
        allow update: if isExistingOwner(userAccountId) && isUnchanged('userAccountId');
        allow delete: if isExistingOwner(userAccountId);

        /**
         * @description Individual messages within a conversation.
         */
        match /messages/{messageId} {
          allow get, list: if isOwner(userAccountId);
          allow create: if isOwner(userAccountId) && request.resource.data.userAccountId == userAccountId;
          allow update: if isExistingOwner(userAccountId) && isUnchanged('userAccountId');
          allow delete: if isExistingOwner(userAccountId);
        }
      }
    }

    /**
     * @description Rules for business profile settings.
     * During prototyping with "auth disabled", we allow access to these collections.
     */
    match /{collectionName}/{userId} {
      allow read, write: if (collectionName in ['businessBasics', 'products', 'faqs', 'brandVoice', 'responseGuidelines', 'advancedSettings']);
    }

    /**
     * @description Global collection of pricing tiers and features. Read-only for all users.
     * @path /subscriptionPlans/{subscriptionPlanId}
     */
    match /subscriptionPlans/{subscriptionPlanId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
  }
}